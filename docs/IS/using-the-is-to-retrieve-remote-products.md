# Using the IS to Retrieve Remote Products
based on Draft Version 1 2006
NISGS [Processing Element] User’s Guide

# Introduction
## Purpose
This document explains how to retrieve remote products using the Information Services (IS). 

The IS is part of the National Polar-orbiting Operational Environmental Satellite System (NPOESS) Preparatory Project (NPP) In-Situ Ground System (NISGS), now under development by NASA’s Goddard Space Flight Center (GSFC) Direct Readout Laboratory (DRL), Code 606.3.   .  

# IS design and function
## Overview
The NISGS Information Services (IS) is a subsystem of the NISGS (see figure 1).    Other NISGS subsystems acquire spacecraft Direct Broadcast telemetry during a satellite pass, remove transmission artifacts and store the resulting packet data in computer-accessible files and execute application programs to generate end products.

The IS is a repository for storing products generated locally by the NISGS or remotely at external sites.  Remote products may be retrieved by the ISRetriever program  or sent to the subdirectory by remote sites.  Stored products can be further processed by the NISGS or made publicly accessible.  

The IS sends status and event messages to the NISGS Status/Event Logging System (NSLS) for monitoring and optionally registers stored products with Data Storage Manager (DSM).  Registered products can then be retrieved from anywhere in the NISGS. 
 
The IS includes an ISDeleter program to periodically remove outdated products from the data subdirectory, an adder program to add static products, and a treemanager program to initially build the subdirectory.  

. 
Bob needs to modify this:
(???) Figure 1: NCS is a Subsystem of NISGS (???)

 Products may be added to the IS internally by the NISGS Data Storage Manager, retrieved directly from a remote site by the ISRetriever, or retrieved by the IS from a local directory written by a remote site.  Products may be retrieved using FTP, HTTP or HTTPS protocols. (see figure 2).

Added external products may registered with the DSM so that they are available for further processing.  Registered products are identified by a unique DSM Product Type.  Products generated by the NISGS are already registered. See TBD for establishing DSM products.

If the IS Deleter is executing, the new product file names should be compared with the deleter policy defined in the deleter’s configuration file to ensure the product’s timely removal from the data subdirectory. 


Ask Bob to add Figure 2

Product retrieval by the IS from a remote or local site is controlled by an XML configuration file.  The file has the general format:

```xml
<Configure>
	<LocalSite
		Program initialization parameters. 
		/>
	
	<RemoteSite
		Remote site 1 protocol, local and remote directory parameters
		/>

	<RemoteSite
		Remote site 2 protocol, local and remote directory parameters
		/>

	<RemoteSite
		Remote site  3 protocol, local and remote directory parameters
		/>
	. . . 
</Configure>
```

Figure 4. Configuration File Overview- The LocalSite section specifies program initialization parameters only.  All retrieval parameters for local or remote sites are specified in “RemoteSite” Sections.  

RemoteSite sections retrieve files using FTP, HTTP and HTTPS protocols.  There may be any number of RemoteSite sections.  An HTTP RemoteSite must minimally provide:

```xml
	<RemoteSite
		siteTitle="unique name of this section"
		localFileName="localpath/filename"
		protocol="http"

		hostName="hostname of remote machine"
		remoteFileName="filename on remote machine"
		remoteDirectory="http directory on remote machine"
		dsmName="DSM productType"
		spacecraft=”spacecraft name”
		/>
```

The “user” parameter default value is “anonymous”. If the dsmName is absent, the product will not be registered with the DSM.  If the spacecraft parameter is specified, the product will be registered as a DSM satTimedAncillary; otherwise the product will be registered as a timedAncillary. 

The “localFileName” parameter value must be the path/filename directly beneath the IS data subdirectory where the retrieved file is to be placed.  Generally, the file name should be unique so that new files do not override existing files.  This may be accomplished by specifying the current date in the filename using Java SimpleDateFormat symbols. Apostrophes must be used to separate literal text from date symbols. By example:

	“'ancillary/temporal/utcpole.'yyyyMMddHH'.dat'"

could generate:

	“ancillary/temporal/utcpole.2006042713.dat”

.  An FTP RemoteSite must minimally provide:

```xml
	<RemoteSite
		siteTitle="unique name of this section"
		localFileName="localpath/filename"
		protocol="ftp"

		user="username on remote machine"
		password="password on remote machine"

		hostName="hostname of remote machine"
		remoteFileName="filename on remote machine"
		remoteDirectory="ftp directory on remote machine"
		dsmName="DSM productType"
		spacecraft=”spacecraft name”
		/>
```

In some situations, the exact file name on a remote ftp site cannot be foreknown.  Here, the “remoteFileName” can be set to a regular expression  and the “sortby” parameter set to a value of  "date", "name",  or "none". The IS will then attempt to retrieve a list of files matching the regular expression and sorted by the “sortby” order.  The last file in the sorted list will be selected for retrieval.  If the  “localFileName” parameter value ends in “/”, then the name of the retrieved file will be appended to form a complete path/file. 

More realistic RemoteSite examples are provided in figure 5.  Appendix TBD contains a complete list of  RemoteSite parameters and default values. 

```xml
<Configure>
	<LocalSite
		NSLSPrint="true"
		/>
	
	<!-- UTCPOLE  (every 3 days) -->
	<RemoteSite
		siteTitle="UTCPole"
		localFileName="'ancillary/temporal/utcpole.'yyyyMMddHH'.dat'"
		pollingHours="72"
		timeoutSec="120"		

		protocol="ftp"
		user="anonymous"
		password="nisgs@is.sci.gsfc.nasa.gov"

		hostName="oceans.gsfc.nasa.gov"
		remoteFileName="utcpole.dat"
		remoteDirectory="COMMON"
		dsmName="UTCPOLE"
		/>

<!-- NORAD TLE Aqua  (every 1 days) -->
	<RemoteSite
		siteTitle="NORAD Aqua TLE"
		localFileName="'ancillary/ephemeris/tle/tle.'yyyyMMddHH'.txt'"
		pollingHours="24"
		
		protocol="http"
		hostName="www.celestrak.com"
		remoteFileName="resource.txt"
		remoteDirectory="/NORAD/elements"
		dsmName="TLE"
		spacecraft="aqua"
		/>
</Configure
```

Figure 5. Configuration File Example

Several parameters in the ISRetriever commandline, and in the configuration file are of special interest when debugging a configuration file.  If the command line contains the parameter/value pair:

-verbose true

then the program initialization values will be printed.

The NSLSLocalLogFile and the NSLSPrint parameters in the LocalSite Section may also be useful when debugging a configuration file.  If the NSLSLocalLogFile is set to a file name, the NSLS will write event messages to that file. If the NSLSPrint parameter is set “true”, NSLS event messages will be printed.

RemoteSite sections have three Boolean parameters useful for debugging a particular RemoteSite section:

The “run” parameter may be set to “false” to prevent execution of a particular RemoteSite section.  If the “run” parameter is absent or “true”, the RemoteSite will attempt execution.

The “test” parameter may be set to “true” to force a RemoteSite to attempt execution only once.  If the “test” parameter is absent or “false”, the remote site will be polled at an interval determined by the “pollingHours” parameter. 

The “verbose” parameter may be set to “true” to print detailed information during retrieval attempts.  If this parameter is  absent or “false”, the detailed information is not printed. 

ISDeleter

The ISDeleter periodically removes outdated files from the IS Data Subdirectory. When new product types are added to the IS Data Subdirectory, consideration should be given to the established deletion policy to avoid untimely removal of files.

The ISDeleter Program reads an XML configuration file that defines the deletion policy, periodically traverses the IS Data Subdirectory, and deletes files matching the defined policy. 

```xml
<Configure>

	<setup 
		initilization and default parameters
	/>

	<cmd  file="regular expression "	delete=”days”  />
	<cmd  file="regular expression "	delete=”days”  />
	<cmd  file="regular expression "	delete=”days”  />
	. . .

</Configure>
```

Figure 6. General Format of the ISDeleter Configuration File. 


The general format of the Configuration file is shown in figure 6.  Policy is specified by a list of “cmd” elements containing file and delete parameters.  File parameters are regular expressions matching the path/file names under the Data Subdirectory.  

The delete parameter value specifies the maximum allowed age of a file in days.  Files matching the regular expression and older than the allowed age are deleted.  If the “delete” parameter is absent or zero, matching files are retained. 

Directory files not matching any of the file names are retained.  Ordinary files not matching any of the file names are deleted if they are older than the maximum allowed default age. 

The subdirectory tree is recursively traversed from the top; if a file is a subdirectory, the traversal descends into that subdirectory. As each file is encounterd, its name is compared to each regular expression in order presented in the configuration file.  The comparisons end when a match is found or the list of regular expressions is exhausted. 

Figure 7 shows an ISDeleter Configuration File example. TBD contains a detailed description of the ISDeleter parameters. 

```xml
<!-- File Deleter Configuration File -->
<Configure>

	<setup 
		   NSLSPrint="false"
		   PollHours="15"
		   AgeDays="15"
	/>

	<!-- Keep all ancillary/spatial  -->
	<cmd file="^ancillary/spatial.*$"	/>

	<!-- Keep Drop Box- There shouldn't be anything here -->
	<cmd file="^dropbox.*$" />

	<!-- Keep all Auxiliary  -->
	<cmd file="^auxiliary.*$"	/>

</Configure>
```

Figure 7. ISDeleter Configuration File Example. 
